#include "PAYLOAD.h"

/* ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::: */
	   /* ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::: Variables interne :::::::::::::::::::::::::::::::::::::::::::::: */	    

/* ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::: */
	   /* ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::: Fonctions static :::::::::::::::::::::::::::::::::::::::::::::: */
	 
static void print_u16_bytes(uint16_t v)
{
    uint8_t b[2];
    memcpy(b, &v, 2);
}
	   
// --------------------------------------------------------------------------------------------------------------------------------------
static void print_u32_bytes(uint32_t v)
{
    uint8_t b[4];
    memcpy(b, &v, 4);
}

// --------------------------------------------------------------------------------------------------------------------------------------
static void to_upper(char *str) {
    if (!str) return;
    for (; *str; ++str) *str = (char)toupper((unsigned char)*str);
}

// --------------------------------------------------------------------------------------------------------------------------------------
static str16_t int8_tronc_hex(int8_t x) 
{
	str16_t reply = {0};
	snprintf(reply.sentence, sizeof(reply.sentence), "%02x", x);
	to_upper(reply.sentence);
    return reply;   // coupe la fraction, vers 0
}

// --------------------------------------------------------------------------------------------------------------------------------------
static str16_t entier_tronc_hex(uint8_t x) 
{
	str16_t reply = {0};
	snprintf(reply.sentence, sizeof(reply.sentence), "%02x", x);
	to_upper(reply.sentence);
    return reply;   // coupe la fraction, vers 0
}

// --------------------------------------------------------------------------------------------------------------------------------------
static str16_t decimal_tronc_char(double x) 
{
	str16_t reply = {0};
	float decim =  x - (int16_t) x;
	snprintf(reply.sentence, sizeof(reply.sentence), "%.8f", decim);
	char *pattern  = strchr(reply.sentence, '.');
    if(pattern) {strcpy(reply.sentence, pattern+1);}
	return reply;
}

// --------------------------------------------------------------------------------------------------------------------------------

// --------------------------------------------------------------------------------------------------------------------------------

// ---------------------------------------------------------------------------------------------------------------------------------
				
// ---------------------------------------------------------------------------------------------------------------------------------
	
// --------------------------------------------------------------------------------------------------------------------------------
str256_t custom_encode(double latitude, double longitude,  int8_t rssi, int8_t snr)
{
	str256_t payload = {0};

	sprintf(payload.sentence, "%s%s%s%s%s%s", 
	entier_tronc_hex(latitude).sentence, decimal_tronc_char(latitude).sentence, 
	entier_tronc_hex(longitude).sentence, decimal_tronc_char(longitude).sentence,
	int8_tronc_hex(abs(rssi)).sentence, int8_tronc_hex(snr).sentence);

	return payload;
}  

//// --------------------------------------------------------------------------------------------------------------------------------
// str256_t custom_decode(char *payload)
//{
//	 
//}
 
/* ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::: */
	   /* ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::: Constructeur :::::::::::::::::::::::::::::::::::::::::::::: */	    
void Payload_build(Payload_t *self)
{
	if (!self) return;
	
    // Renseigne les pointeurs de fonctions (méthodes “virtuelles” de l’objet).
    self->custom_encode = custom_encode;
    //self->custom_decode = custom_decode;

}

// -------------------------------------------------------------------------------------------------------------------------------------





// -----------------------------------------------------------------------------------------------------------------------------
   // ----------------------------------------------------------------------------------------------------------
